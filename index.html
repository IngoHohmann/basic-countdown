<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>CountDown Timer</title>
        <style type="text/css">
        #remaining {
            color: green;
        }
        </style>
    </head>
    <body>
        <div style="font-size:200%"><span id="remaining"></span></div>
        <table>
        <tr><td class="label">Time:</td> <td id="time"></td></tr>
        <tr><td class="label">Start:</td> <td id="starttime"></td></tr>
        <tr><td class="label">End:</td> <td id="endtime"></td></tr>
        </table>
        <input id="length" style="width: 70px"/> min<br> 
        <button id="start" onclick="startTimer()">--- Start ---</button>
        <div id="current"></div>
        <div>
            <h1>About</h1>
            <p>This is a small example app for remotestorage usage.</p>
            <p>Additionally I may use it to be able to track my breaks at work on my mobile phone.</p>
            <p>Just fill in a length in minutes and click start.</p>
            <p>End time is set to the end of the length's minute from now.</p>
            <p>Enjoy!</p>
            <p>P.S. This is beta software, it's working, no work on making it look nice has been done.</p>
        </div>
    </body>
    <script src="remotestorage.js"></script>
    <script src="timer.js"></script>
    <script src="moment.js"></script>
    <script>
        var endTime;
        var running = false;
        var sign = "&nbsp;";
        var elTime, elRemaining;
        
        function fm( num, places) {
                // todo: negative values are not formatted correctly
                //       same for decimals
                if (!places) {places = 2};
                var s = num.toString();
                for (i = s.length ; i < places ; i++) {
                        s = "0" + s
                }
                return s;
        }
        
        function fmTime( h, m, s) {
                return fm( h) + ":" + fm( m) + ":" + fm( s);
        }

        function clock(){
            var now = moment();
            elTime.innerHTML = now.format("HH:mm:ss")
            if (running) {
                var dm = moment(endTime).diff( now, "seconds");
                if (dm < 0) {
                        dm = now.diff( endTime, "seconds");
                        sign = "+";
                }
                                
                var h = Math.floor(dm / 3600);
                var m = Math.floor((dm - (h * 3600)) / 60);
                var s = dm % 60;

                elRemaining.innerHTML = sign + fmTime( h, m, s);
            }
        }
        
        function startTimer(){
            var now = moment()
            endTime = moment(now).add(document.getElementById("length").value, "minutes").set("second", 59);
            document.getElementById("starttime").innerHTML = now.format("HH:mm:ss");
            document.getElementById("endtime").innerHTML = endTime.format("HH:mm:ss");
            running = true; 
            sign    = "&nbsp;&nbsp;";
            remoteStorage.timer.setTimer( now.format("HH:mm:ss"), endTime.format("HH:mm:ss"), document.getElementById("length").value, running)
        }

        function stopTimer(){
            running = false;
            elTime = "--- stopped ---"
        }        
        
        elTime = document.getElementById("time");
        elRemaining = document.getElementById("remaining");
        window.setInterval("clock()", 500);
    </script>
    <script>
        // set this to true, to see logs
        RemoteStorage.config.logging = false;
        RemoteStorage.config.changeEvents = {
          local: true,
          window: true,
          remote: true,
          conflict: true
        };

        function displayTimer( e){
            // uncomment, to show the event on the webpage
            // document.getElementById('current').innerHTML = JSON.stringify( e);
            document.getElementById("starttime").innerHTML = e.newValue.starttime; 
            document.getElementById("length").value = e.newValue.length;
            document.getElementById("endtime").innerHTML = e.newValue.endtime; 
            endTime = moment(e.newValue.endtime, "HH:mm:ss");
            running = e.newValue.running;
        }
    
        remoteStorage.access.claim('timer', 'rw');
        remoteStorage.displayWidget();
        remoteStorage.timer.onChange(displayTimer);
    
    </script>
</html>